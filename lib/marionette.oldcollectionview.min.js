/**
* @license
* MarionetteJS (Backbone.Marionette)
* ----------------------------------
* v0.1.0
*
* Copyright (c)2017 Derick Bailey, Muted Solutions, LLC.
* Distributed under MIT license
*
* http://marionettejs.com
*/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("backbone.marionette"),require("underscore"),require("backbone")):"function"==typeof define&&define.amd?define(["exports","backbone.marionette","underscore","backbone"],t):t(e.oldcollectionview={},e.Backbone.Marionette,e._,e.Backbone)}(this,function(e,t,i,n){"use strict";function r(e,t,i){return i.toUpperCase()}function s(e){for(var n=arguments.length,r=Array(n>1?n-1:0),s=1;s<n;s++)r[s-1]=arguments[s];var o=b(e),h=t.getOption(this,o),d=void 0;return i.isFunction(h)&&(d=h.apply(this,r)),this.trigger.apply(this,arguments),d}function o(e){for(var t=arguments.length,n=Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return i.isFunction(e.triggerMethod)?e.triggerMethod.apply(e,n):s.apply(e,n)}function h(e){e._isRendered||(e.supportsRenderLifecycle||o(e,"before:render",e),e.render(),e.supportsRenderLifecycle||(e._isRendered=!0,o(e,"render",e)))}function d(e){if(e.destroy)e.destroy();else{e.supportsDestroyLifecycle||o(e,"before:destroy",e);var t=e._isAttached&&!e._shouldDisableEvents;t&&o(e,"before:detach",e),e.remove(),t&&(e._isAttached=!1,o(e,"detach",e)),e._isDestroyed=!0,e.supportsDestroyLifecycle||o(e,"destroy",e)}}function l(e,t,n){e._getImmediateChildren&&i.each(e._getImmediateChildren(),function(e){n(e)&&o(e,t,e)})}function c(e){return!e._isAttached}function a(e){return!!c(e)&&(e._isAttached=!0,!0)}function u(e){return e._isAttached}function f(e){return!!u(e)&&(e._isAttached=!1,!0)}function _(e){e._isAttached&&e._isRendered&&o(e,"dom:refresh",e)}function p(e){e._isAttached&&e._isRendered&&o(e,"dom:remove",e)}function v(){l(this,"before:attach",c)}function w(){l(this,"attach",a),_(this)}function g(){l(this,"before:detach",u),p(this)}function m(){l(this,"detach",f)}function y(){p(this)}function C(){_(this)}function V(e){e._areViewEventsMonitored||!1===e.monitorViewEvents||(e._areViewEventsMonitored=!0,e.on({"before:attach":v,attach:w,"before:detach":g,detach:m,"before:render":y,render:C}))}t=t&&t.hasOwnProperty("default")?t.default:t,i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n;var E=/(^|:)(\w)/gi,b=i.memoize(function(e){return"on"+e.replace(E,r)}),M=["forEach","each","map","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","toArray","first","initial","rest","last","without","isEmpty","pluck","reduce","partition"],B=function(e){this._views={},this._indexByModel={},this._indexByCustom={},this._updateLength(),i.each(e,i.bind(this.add,this))};!function(e,t){i.each(M,function(n){e[n]=function(){var e=i.result(this,t),r=Array.prototype.slice.call(arguments);return i[n].apply(i,[e].concat(r))}})}(B.prototype,"_getViews"),i.extend(B.prototype,{_getViews:function(){return i.values(this._views)},add:function(e,t){return this._add(e,t)._updateLength()},_add:function(e,t){var i=e.cid;return this._views[i]=e,e.model&&(this._indexByModel[e.model.cid]=i),t&&(this._indexByCustom[t]=i),this},findByModel:function(e){return this.findByModelCid(e.cid)},findByModelCid:function(e){var t=this._indexByModel[e];return this.findByCid(t)},findByCustom:function(e){var t=this._indexByCustom[e];return this.findByCid(t)},findByIndex:function(e){return i.values(this._views)[e]},findByCid:function(e){return this._views[e]},remove:function(e){return this._remove(e)._updateLength()},_remove:function(e){var t=e.cid;return e.model&&delete this._indexByModel[e.model.cid],i.some(this._indexByCustom,i.bind(function(e,i){if(e===t)return delete this._indexByCustom[i],!0},this)),delete this._views[t],this},_updateLength:function(){return this.length=i.size(this._views),this}});var x=t.View.setDomApi,A=i.pick(t.View.prototype,"Dom","supportsRenderLifecycle","supportsDestroyLifecycle","_isDestroyed","isDestroyed","_isRendered","isRendered","_isAttached","isAttached","delegateEvents","_getEvents","getTriggers","delegateEntityEvents","undelegateEntityEvents","destroy","_removeElement","bindUIElements","unbindUIElements","getUI","childViewEventPrefix","triggerMethod","_buildEventProxies","_proxyChildViewEvents","_childViewEventHandler","_initBehaviors","_getBehaviors","_getBehaviorTriggers","_getBehaviorEvents","_proxyBehaviorViewProperties","_delegateBehaviorEntityEvents","_undelegateBehaviorEntityEvents","_destroyBehaviors","_removeBehavior","_bindBehaviorUIElements","_unbindBehaviorUIElements","_triggerEventOnBehaviors","normalizeMethods","_setOptions","mergeOptions","getOption","bindEvents","unbindEvents","_delegateEntityEvents","_undelegateEntityEvents","_getViewTriggers","normalizeUIKeys","normalizeUIString","normalizeUIValues","_getUIBindings","_bindUIElements","_unbindUIElements","_getUI"),O=t.isNodeAttached,D=t.Error,I=["behaviors","childView","childViewEventPrefix","childViewEvents","childViewOptions","childViewTriggers","collectionEvents","events","filter","emptyView","emptyViewOptions","modelEvents","reorderOnSort","sort","triggers","ui","viewComparator"],R=n.View.extend({sort:!0,constructor:function(e){this.render=i.bind(this.render,this),this._setOptions(e),this.mergeOptions(e,I),V(this),this._initBehaviors(),this.once("render",this._initialEvents),this._initChildViewStorage(),this._bufferedChildren=[];var t=Array.prototype.slice.call(arguments);t[0]=this.options,n.View.prototype.constructor.apply(this,t),this.delegateEntityEvents(),this._triggerEventOnBehaviors("initialize",this)},_startBuffering:function(){this._isBuffering=!0},_endBuffering:function(){var e=this._isAttached&&!1!==this.monitorViewEvents?this._getImmediateChildren():[];this._isBuffering=!1,i.each(e,function(e){o(e,"before:attach",e)}),this.attachBuffer(this,this._createBuffer()),i.each(e,function(e){e._isAttached=!0,o(e,"attach",e)}),this._bufferedChildren=[]},_getImmediateChildren:function(){return i.values(this.children._views)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"update",this._onCollectionUpdate),this.listenTo(this.collection,"reset",this.render),this.sort&&this.listenTo(this.collection,"sort",this._sortViews))},_onCollectionAdd:function(e,t,n){var r=void 0!==n.at&&(n.index||t.indexOf(e));(this.filter||!1===r)&&(r=i.indexOf(this._filteredSortedModels(r),e)),this._shouldAddChild(e,r)&&(this._destroyEmptyView(),this._addChild(e,r))},_onCollectionUpdate:function(e,t){var i=t.changes;this._removeChildModels(i.removed)},_removeChildModels:function(e){var t=this._getRemovedViews(e);t.length&&(this.children._updateLength(),this._updateIndices(t,!1),this.isEmpty()&&this._showEmptyView())},_getRemovedViews:function(e){var t=this;return i.reduce(e,function(e,i){var n=i&&t.children.findByModel(i);return!n||n._isDestroyed?e:(t._removeChildView(n),e.push(n),e)},[])},_removeChildView:function(e){this.triggerMethod("before:remove:child",this,e),this.children._remove(e),e._shouldDisableEvents=!1===this.monitorViewEvents,d(e),this.stopListening(e),this.triggerMethod("remove:child",this,e)},setElement:function(){var e=!!this.el;return n.View.prototype.setElement.apply(this,arguments),e&&(this._isAttached=O(this.el)),this},render:function(){return this._isDestroyed?this:(this.triggerMethod("before:render",this),this._renderChildren(),this._isRendered=!0,this.triggerMethod("render",this),this)},setFilter:function(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).preventRender,i=this._isRendered&&!this._isDestroyed,n=this.filter!==e;if(i&&n&&!t){var r=this._filteredSortedModels();this.filter=e;var s=this._filteredSortedModels();this._applyModelDeltas(s,r)}else this.filter=e;return this},removeFilter:function(e){return this.setFilter(null,e)},_applyModelDeltas:function(e,t){var n=this,r={};i.each(e,function(e,t){!n.children.findByModel(e)&&n._onCollectionAdd(e,n.collection,{at:t}),r[e.cid]=!0});var s=i.filter(t,function(e){return!r[e.cid]&&n.children.findByModel(e)});this._removeChildModels(s)},reorder:function(){var e=this,t=this.children,n=this._filteredSortedModels();if(!n.length&&this._showingEmptyView)return this;if(i.some(n,function(e){return!t.findByModel(e)}))this.render();else{var r=[],s=i.reduce(this.children._views,function(e,t){var s=i.indexOf(n,t.model);return-1===s?(r.push(t.model),e):(t._index=s,e[s]=t.el,e)},new Array(n.length));this.triggerMethod("before:reorder",this);var o=this.Dom.createBuffer();i.each(s,function(t){e.Dom.appendContents(o,t)}),this._appendReorderedChildren(o),this._removeChildModels(r),this.triggerMethod("reorder",this)}return this},resortView:function(){return this.reorderOnSort?this.reorder():this._renderChildren(),this},_sortViews:function(){var e=this,t=this._filteredSortedModels();i.find(t,function(t,i){var n=e.children.findByModel(t);return!n||n._index!==i})&&this.resortView()},_emptyViewIndex:-1,_appendReorderedChildren:function(e){this.Dom.appendContents(this.el,e,{_$el:this.$el})},_renderChildren:function(){this._isRendered&&(this._destroyEmptyView(),this._destroyChildren());var e=this._filteredSortedModels();this.isEmpty({processedModels:e})?this._showEmptyView():(this.triggerMethod("before:render:children",this),this._startBuffering(),this._showCollection(e),this._endBuffering(),this.triggerMethod("render:children",this))},_createView:function(e,t){var i=this._getChildView(e),n=this._getChildViewOptions(e,t);return this.buildChildView(e,i,n)},_setupChildView:function(e,t){V(e),this._proxyChildViewEvents(e),this.sort&&(e._index=t)},_showCollection:function(e){i.each(e,i.bind(this._addChild,this)),this.children._updateLength()},_filteredSortedModels:function(e){if(!this.collection||!this.collection.length)return[];var t=this.getViewComparator(),i=this.collection.models;if(e=Math.min(Math.max(e,0),i.length-1),t){var n=void 0;e&&(n=i[e],i=i.slice(0,e).concat(i.slice(e+1))),i=this._sortModelsBy(i,t),n&&i.splice(e,0,n)}return i=this._filterModels(i)},getViewComparator:function(){return this.viewComparator},_filterModels:function(e){var t=this;return this.filter&&(e=i.filter(e,function(e,i){return t._shouldAddChild(e,i)})),e},_sortModelsBy:function(e,t){return"string"==typeof t?i.sortBy(e,function(e){return e.get(t)}):1===t.length?i.sortBy(e,i.bind(t,this)):i.clone(e).sort(i.bind(t,this))},_showEmptyView:function(){var e=this._getEmptyView();if(e&&!this._showingEmptyView){this._showingEmptyView=!0;var t=new n.Model,r=this.emptyViewOptions||this.childViewOptions;i.isFunction(r)&&(r=r.call(this,t,this._emptyViewIndex));var s=this.buildChildView(t,e,r);this.triggerMethod("before:render:empty",this,s),this.addChildView(s,0),this.triggerMethod("render:empty",this,s)}},_destroyEmptyView:function(){this._showingEmptyView&&(this.triggerMethod("before:remove:empty",this),this._destroyChildren(),delete this._showingEmptyView,this.triggerMethod("remove:empty",this))},_getEmptyView:function(){var e=this.emptyView;if(e)return this._getView(e)},_getChildView:function(e){var t=this.childView;if(!t)throw new D({name:"NoChildViewError",message:'A "childView" must be specified'});if(!(t=this._getView(t,e)))throw new D({name:"InvalidChildViewError",message:'"childView" must be a view class or a function that returns a view class'});return t},_getView:function(e,t){return e.prototype instanceof n.View||e===n.View?e:i.isFunction(e)?e.call(this,t):void 0},_addChild:function(e,t){var i=this._createView(e,t);return this.addChildView(i,t),i},_getChildViewOptions:function(e,t){return i.isFunction(this.childViewOptions)?this.childViewOptions(e,t):this.childViewOptions},addChildView:function(e,t){return this.triggerMethod("before:add:child",this,e),this._setupChildView(e,t),this._isBuffering?this.children._add(e):(this._updateIndices(e,!0),this.children.add(e)),h(e),this._attachView(e,t),this.triggerMethod("add:child",this,e),e},_updateIndices:function(e,t){if(this.sort)if(t){var n=i.isArray(e)?i.max(e,"_index"):e;i.isObject(n)&&i.each(this.children._views,function(e){e._index>=n._index&&(e._index+=1)})}else i.each(i.sortBy(this.children._views,"_index"),function(e,t){e._index=t})},_attachView:function(e,t){var i=!e._isAttached&&!this._isBuffering&&this._isAttached&&!1!==this.monitorViewEvents;i&&o(e,"before:attach",e),this.attachHtml(this,e,t),i&&(e._isAttached=!0,o(e,"attach",e))},buildChildView:function(e,t,n){return new t(i.extend({model:e},n))},removeChildView:function(e){return!e||e._isDestroyed?e:(this._removeChildView(e),this.children._updateLength(),this._updateIndices(e,!1),e)},isEmpty:function(e){var t=void 0;return i.result(e,"processedModels")?t=e.processedModels:(t=this.collection?this.collection.models:[],t=this._filterModels(t)),0===t.length},attachBuffer:function(e,t){this.Dom.appendContents(e.el,t,{_$el:e.$el})},_createBuffer:function(){var e=this,t=this.Dom.createBuffer();return i.each(this._bufferedChildren,function(i){e.Dom.appendContents(t,i.el,{_$contents:i.$el})}),t},attachHtml:function(e,t,i){e._isBuffering?e._bufferedChildren.splice(i,0,t):e._insertBefore(t,i)||e._insertAfter(t)},_insertBefore:function(e,t){var n=void 0;return this.sort&&t<this.children.length-1&&(n=i.find(this.children._views,function(e){return e._index===t+1})),!!n&&(this.beforeEl(n.el,e.el),!0)},beforeEl:function(e,t){this.$(e).before(t)},_insertAfter:function(e){this.Dom.appendContents(this.el,e.el,{_$el:this.$el,_$contents:e.$el})},_initChildViewStorage:function(){this.children=new B},_removeChildren:function(){this._destroyChildren()},_destroyChildren:function(e){this.children.length&&(this.triggerMethod("before:destroy:children",this),i.each(this.children._views,i.bind(this._removeChildView,this)),this.children._updateLength(),this.triggerMethod("destroy:children",this))},_shouldAddChild:function(e,t){var n=this.filter;return!i.isFunction(n)||n.call(this,e,t,this.collection)}},{setDomApi:x});i.extend(R.prototype,A);var $=t.Error,T=t.View,U=["childViewContainer","template","templateContext"],L=R.extend({constructor:function(e){this.mergeOptions(e,U),R.prototype.constructor.apply(this,arguments)},_initialEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this._onCollectionAdd),this.listenTo(this.collection,"update",this._onCollectionUpdate),this.listenTo(this.collection,"reset",this.renderChildren),this.sort&&this.listenTo(this.collection,"sort",this._sortViews))},_getChildView:function(e){var t=this.childView;if(!t)return this.constructor;if(!(t=this._getView(t,e)))throw new $({name:"InvalidChildViewError",message:'"childView" must be a view class or a function that returns a view class'});return t},serializeData:function(){return this.serializeModel()},render:function(){return this._isDestroyed?this:(this._isRendering=!0,this.resetChildViewContainer(),this.triggerMethod("before:render",this),this._renderTemplate(),this.bindUIElements(),this.renderChildren(),this._isRendering=!1,this._isRendered=!0,this.triggerMethod("render",this),this)},renderChildren:function(){(this._isRendered||this._isRendering)&&R.prototype._renderChildren.call(this)},attachBuffer:function(e,t){var i=this.getChildViewContainer(e);this.Dom.appendContents(i[0],t,{_$el:i})},_insertAfter:function(e){var t=this.getChildViewContainer(this,e);this.Dom.appendContents(t[0],e.el,{_$el:t,_$contents:e.$el})},_appendReorderedChildren:function(e){var t=this.getChildViewContainer(this);this.Dom.appendContents(t[0],e,{_$el:t})},getChildViewContainer:function(e,t){if(e.$childViewContainer)return e.$childViewContainer;var n=void 0;if(e.childViewContainer){var r=i.result(e,"childViewContainer");if((n="@"===r.charAt(0)&&e.ui?e.ui[r.substr(4)]:this.$(r)).length<=0)throw new $({name:"ChildViewContainerMissingError",message:'The specified "childViewContainer" was not found: '+e.childViewContainer})}else n=e.$el;return e.$childViewContainer=n,n},resetChildViewContainer:function(){this.$childViewContainer&&(this.$childViewContainer=void 0)}}),S=i.pick(T.prototype,"serializeModel","getTemplate","_renderTemplate","_renderHtml","mixinTemplateContext","attachElContent");i.extend(L.prototype,S),t.OldCollectionView=R,t.OldCompositeView=L,e.OldCollectionView=R,e.OldCompositeView=L,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=marionette.oldcollectionview.min.js.map